{% extends "base.html" %}
{% load tz %}
{% block content %}
<main class="px-8 py-8">
  <div class="container mx-auto max-w-6xl">
    <div class="bg-white shadow rounded-lg p-6">
      <div class="inline-flex items-center space-x-4">
        <h1 class="text-2xl font-bold">Devoluciones</h1>
        <svg class="size-12 ml-6" fill="#77df83" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 256 190" enable-background="new 0 0 256 190" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M48.12,27.903C48.12,13.564,59.592,2,74.023,2c14.339,0,25.903,11.564,25.903,25.903 C99.834,42.335,88.27,53.806,74.023,53.806C59.684,53.806,48.12,42.242,48.12,27.903z M191,139h-47V97c0-20.461-17.881-37-38-37H43 C20.912,60,1.99,79.14,2,98v77c-0.026,8.533,6.001,12.989,12,13c6.014,0.011,12-4.445,12-13v-75h8v88h78v-88h8l0.081,50.37 c-0.053,8.729,5.342,12.446,10.919,12.63h60C207.363,163,207.363,139,191,139z M243.604,88.319c0.011-0.371,0.042-0.625,0.042-0.999 c0-21.939-17.861-39.752-39.801-39.752c-11.266,0-21.444,4.669-28.678,12.218l9.127,9.09c4.914-5.203,11.864-8.451,19.563-8.451 c14.829,0,26.9,12.065,26.9,26.894c0,0.375-0.005,0.627-0.021,0.999h-10.432l16.875,16.877L254,88.319H243.604z M187.389,88.319 l-16.875-16.637l-16.822,16.637h10.42c0.596,21.423,18.17,38.791,39.734,38.791c10.683,0,20.408-4.233,27.56-11.112l-9.132-9.096 c-4.816,4.537-11.297,7.317-18.418,7.317c-14.454,0-26.311-11.584-26.9-25.901H187.389z"></path> </g></svg>
      </div>
      <div class="flex justify-end -mt-10">
        <a href="{% url 'loan_history' %}" class="px-3 py-2 bg-blue-600 text-white rounded">Ver historial de devoluciones</a>
      </div>
      </div>
      {% if loans and loans.object_list %}
        <ul class="space-y-3" id="loans-list">
          {% for loan in loans.object_list %}
            {% include 'tasks/_loan_item.html' with loan=loan %}
          {% endfor %}
        </ul>

        <div class="mt-4 flex justify-center">
          <nav class="inline-flex items-center">
            {% if loans.has_previous %}
              <a href="?page={{ loans.previous_page_number }}" class="px-3 py-1 border rounded-l">Anterior</a>
            {% else %}
              <span class="px-3 py-1 border rounded-l text-gray-400">Anterior</span>
            {% endif %}
            <span class="px-4 py-1 border-t border-b">Página {{ loans.number }} de {{ loans.paginator.num_pages }}</span>
            {% if loans.has_next %}
              <a href="?page={{ loans.next_page_number }}" class="px-3 py-1 border rounded-r">Siguiente</a>
            {% else %}
              <span class="px-3 py-1 border rounded-r text-gray-400">Siguiente</span>
            {% endif %}
          </nav>
        </div>
      {% else %}
        <div>No tiene préstamos registrados.</div>
      {% endif %}
    </div>
  </div>
</main>
<script>
  (function(){
    function getCSRF(){ try{ var t=document.querySelector('input[name=csrfmiddlewaretoken]'); if(t) return t.value;}catch(e){}; function getCookie(n){var v=document.cookie.match('(^|;)\\s*'+n+'\\s*=\\s*([^;]+)'); return v? v.pop(): ''; } return getCookie('csrftoken'); }

    // Modal para devolver con reporte y puntuaciones
    var returnModalHtml = `
      <div id="return-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg w-11/12 max-w-xl p-6 m-auto mt-20">
          <h3 class="text-lg font-semibold mb-3">Devolver libro</h3>
          <div id="return-error" class="text-sm text-red-600 hidden mb-2"></div>
          <div class="mb-3">
            <label class="block text-sm">Reporte del estado del Libro</label>
            <textarea id="return_report" class="w-full border rounded p-2" rows="4"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label class="block text-sm">Calificación de estado del libro</label>
              <select id="return_book_rating" class="w-full border rounded p-2">
                <option value="">--</option>
                <option value="1">1 - Pésimo</option>
                <option value="2">2 - Malo</option>
                <option value="3">3 - Regular</option>
                <option value="4">4 - Bueno</option>
                <option value="5">5 - Excelente</option>
              </select>
            </div>
            <div>
              <label class="block text-sm">Calificación Usuario</label>
              <select id="return_receiver_rating" class="w-full border rounded p-2">
                <option value="">--</option>
                <option value="1">1 - Pésimo</option>
                <option value="2">2 - Malo</option>
                <option value="3">3 - Regular</option>
                <option value="4">4 - Bueno</option>
                <option value="5">5 - Excelente</option>
              </select>
            </div>
          </div>
          <div class="flex justify-end gap-2">
            <button id="return-cancel" class="px-4 py-2 border rounded">Cancelar</button>
            <button id="return-submit" class="px-4 py-2 bg-green-600 text-white rounded">Enviar devolución</button>
          </div>
        </div>
      </div>`;
    document.body.insertAdjacentHTML('beforeend', returnModalHtml);
    var returnModal = document.getElementById('return-modal');
    var returnReport = document.getElementById('return_report');
    var returnBookRating = document.getElementById('return_book_rating');
    var returnReceiverRating = document.getElementById('return_receiver_rating');
    var returnError = document.getElementById('return-error');
    var activeLoanId = null;

    function openReturnModal(loanId){ activeLoanId = loanId; returnReport.value=''; returnBookRating.value=''; returnReceiverRating.value=''; returnError.textContent=''; returnError.classList.add('hidden'); returnModal.classList.remove('hidden'); }
    function closeReturnModal(){ activeLoanId = null; returnModal.classList.add('hidden'); }

    document.getElementById('return-cancel').addEventListener('click', function(){ closeReturnModal(); });

    document.getElementById('return-submit').addEventListener('click', function(){
      if(!activeLoanId) return;
      var data = new URLSearchParams();
      data.append('return_report', returnReport.value || '');
      if(returnBookRating.value) data.append('return_book_rating', returnBookRating.value);
      if(returnReceiverRating.value) data.append('return_receiver_rating', returnReceiverRating.value);
      fetch('{% url "loan_return" 0 %}'.replace('/0/','/' + activeLoanId + '/'), {
        method: 'POST', headers: {'X-CSRFToken': getCSRF(), 'X-Requested-With':'XMLHttpRequest', 'Content-Type':'application/x-www-form-urlencoded'}, body: data.toString(), credentials: 'same-origin'
      }).then(r=>r.json()).then(function(data){
        if(data && data.ok){
            // si el servidor devolvió HTML del loan, reemplazar la fila entera
            if(data.loan_html){
              try{
                var existing = document.getElementById('loan-' + activeLoanId);
                if(existing){
                  // reemplazar manteniendo el mismo lugar en la lista
                  var wrapper = document.createElement('div');
                  wrapper.innerHTML = data.loan_html.trim();
                  var newLi = wrapper.firstChild;
                  existing.parentNode.replaceChild(newLi, existing);
                }
              }catch(e){ console.error('Error al reemplazar HTML recibido:', e); }
            } else {
              // fallback: comportamiento anterior mínimo
              var btn = document.querySelector('.ajax-return-btn[data-loan-id="' + activeLoanId + '"]');
              if(btn){ var li = btn.closest('li'); if(li) li.remove(); }
            }
            // re-formatear fechas en el contenido reemplazado
            (function(){
              function formatISOEl(container){
                container.querySelectorAll('[data-approved-at]').forEach(function(el){
                  try{ var iso = el.getAttribute('data-approved-at'); var dt = new Date(iso); if(isNaN(dt.getTime())) dt = new Date(iso.replace(/(\+|-)([0-9]{2})([0-9]{2})$/, '$1$2:$3')); var txt = isNaN(dt.getTime()) ? iso : dt.toLocaleString(); var span = el.querySelector('.approved-placeholder'); if(span) span.textContent = txt; }
                  catch(e){}
                });
                container.querySelectorAll('[data-returned-at]').forEach(function(el){
                  try{ var iso = el.getAttribute('data-returned-at'); var dt = new Date(iso); if(isNaN(dt.getTime())) dt = new Date(iso.replace(/(\+|-)([0-9]{2})([0-9]{2})$/, '$1$2:$3')); var txt = isNaN(dt.getTime()) ? iso : dt.toLocaleString(); var span = el.querySelector('.returned-placeholder'); if(span) span.textContent = txt; }
                  catch(e){}
                });
              }
              var parent = document.getElementById('loans-list') || document;
              formatISOEl(parent);
            })();
            try{ if(window.refreshCartModal) window.refreshCartModal(); }catch(e){}
            closeReturnModal();
        } else {
          try{ returnError.textContent = (data && data.error) ? data.error : 'No se pudo procesar la devolución'; returnError.classList.remove('hidden'); }catch(e){ returnError.textContent = 'Error'; returnError.classList.remove('hidden'); }
        }
      }).catch(function(){ returnError.textContent = 'Error de red'; returnError.classList.remove('hidden'); });
    });

    document.querySelectorAll('.ajax-return-btn').forEach(function(btn){ btn.addEventListener('click', function(){ openReturnModal(btn.getAttribute('data-loan-id')); }); });
  })();
</script>
<script>
  // Formatea en el cliente las fechas ISO que vienen en data-approved-at / data-returned-at
  (function(){
    function formatISO(el, attrName, placeholderClass){
      try{
        var iso = el.getAttribute(attrName);
        if(!iso) return;
        var dt = new Date(iso);
        if(isNaN(dt.getTime())){
          // intentar parseo con replace si hay +0000 sin colon
          try{ dt = new Date(iso.replace(/(\+|-)([0-9]{2})([0-9]{2})$/, '$1$2:$3')); }catch(e){}
        }
        var txt = isNaN(dt.getTime()) ? iso : dt.toLocaleString();
        var span = el.querySelector('.' + placeholderClass);
        if(span) span.textContent = txt;
        else el.textContent = txt;
      }catch(e){ /* ignore */ }
    }

    document.querySelectorAll('[data-approved-at]').forEach(function(el){ formatISO(el, 'data-approved-at', 'approved-placeholder'); });
    document.querySelectorAll('[data-returned-at]').forEach(function(el){ formatISO(el, 'data-returned-at', 'returned-placeholder'); });
  })();
</script>
{% endblock %}