{% extends "base.html" %}
{% block content %}
<main class="px-4 md:px-8 py-8 min-h-screen" id="return-requests-hub">
  <div class="container mx-auto max-w-6xl">
    <div class="glass-card shadow-2xl rounded-3xl p-6 md:p-10 mb-8 border border-white/30 backdrop-blur-2xl">
      <h1 class="text-indigo-950 text-xl md:text-3xl font-extrabold uppercase tracking-tight mb-8">Centro de Devoluciones</h1>

      {# SECCIÓN 1: PRÉSTAMOS ACTIVOS (Para usuarios: qué pueden devolver. Para staff: qué está prestado) #}
      <section class="mb-12">
        <h2 class="text-lg md:text-xl font-bold mb-6 text-emerald-700 uppercase tracking-widest flex items-center gap-3">
            <div class="p-2 glass-card rounded-lg bg-emerald-50/50 shadow-sm">
                <svg class="size-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18 18.246 18.477 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
            </div>
            {% if is_staff %}Préstamos Activos (Global){% else %}Mis Préstamos Activos{% endif %}
        </h2>
        {% if active_loans %}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for loan in active_loans %}
            <div class="glass-card p-5 rounded-2xl bg-white/40 shadow-sm border-white/50 group transition-all hover:bg-white/60">
                <div class="font-bold text-gray-800">{{ loan.book.titulo }}</div>
                <div class="text-xs text-gray-500 mb-2">Cota: {{ loan.book.cota }}</div>
                {% if is_staff %}
                <div class="text-sm font-medium text-indigo-600 mb-2">Usuario: {{ loan.user.get_full_name|default:loan.user.username }}</div>
                {% endif %}
                <div class="flex justify-between items-center mt-4">
                    <span class="text-xs text-gray-400 italic">Desde: {{ loan.approved_at|date:"d/m/Y" }}</span>
                    <a href="{% url 'loan_return' loan.id %}" class="bg-emerald-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-emerald-700 transition">
                      Devolver
                    </a>
                </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-gray-500 italic">No hay préstamos activos en este momento.</p>
        {% endif %}
      </section>

      {# SECCIÓN 2: SOLICITUDES DE DEVOLUCIÓN (Pendientes de confirmar) #}
      <section class="mb-12">
        <h2 class="text-lg md:text-xl font-bold mb-6 text-amber-700 uppercase tracking-widest flex items-center gap-3">
            <div class="p-2 glass-card rounded-lg bg-amber-50/50 shadow-sm">
                <svg class="size-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            {% if is_staff %}Confirmaciones Pendientes{% else %}Mis Devoluciones en Proceso{% endif %}
        </h2>
        {% if pending_returns %}
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 border">
              <thead class="bg-amber-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-amber-800 uppercase">Libro</th>
                  {% if is_staff %}<th class="px-4 py-2 text-left text-xs font-medium text-amber-800 uppercase">Solicitante</th>{% endif %}
                  <th class="px-4 py-2 text-left text-xs font-medium text-amber-800 uppercase">Acción</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for loan in pending_returns %}
                <tr>
                  <td class="px-4 py-3">
                    <div class="text-sm font-medium">{{ loan.book.titulo }}</div>
                    <div class="text-xs text-gray-500">{{ loan.book.cota }}</div>
                  </td>
                  {% if is_staff %}
                  <td class="px-4 py-3 text-sm">
                    {{ loan.user.get_full_name|default:loan.user.username }}<br>
                    <span class="text-xs text-gray-400">CI: {{ loan.user.cedula }}</span>
                  </td>
                  {% endif %}
                  <td class="px-4 py-3">
                    {% if is_staff %}
                    <a href="{% url 'loan_return' loan.id %}" class="text-amber-600 hover:text-amber-900 font-bold border border-amber-600 px-2 rounded">Confirmar Recibo</a>
                    {% else %}
                    <span class="text-amber-600 text-xs font-bold bg-amber-50 px-2 py-1 rounded-full">Pendiente de confirmación</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-gray-500 italic text-sm">No hay solicitudes de devolución pendientes.</p>
        {% endif %}
      </section>

      {# SECCIÓN 3: HISTORIAL DE DEVOLUCIONES #}
      <section>
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 border-b pb-2">
            <h2 class="text-xl font-semibold text-gray-700 flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Historial de Devoluciones
            </h2>
            <form method="GET" class="flex gap-2 mt-2 md:mt-0">
                <input type="text" name="q_history" value="{{ q_history }}" placeholder="Buscar libro..." class="border rounded px-3 py-1 text-sm focus:ring-2 focus:ring-gray-300 outline-none">
                <button type="submit" class="bg-gray-200 px-3 py-1 rounded text-sm font-bold hover:bg-gray-300">Filtrar</button>
            </form>
        </div>

        {% if history_loans and history_loans.object_list %}
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-100">
              <thead>
                <tr class="text-left text-xs font-bold text-gray-400 uppercase tracking-wider">
                  <th class="px-4 py-2">Libro</th>
                  {% if is_staff %}<th class="px-4 py-2">Usuario</th>{% endif %}
                  <th class="px-4 py-2">Fecha Devolución</th>
                  <th class="px-4 py-2 text-center">Calificación</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-50 text-sm">
                {% for loan in history_loans.object_list %}
                <tr class="hover:bg-gray-50/50">
                  <td class="px-4 py-3">
                    <div class="text-gray-900">{{ loan.book.titulo }}</div>
                    <div class="text-xs text-gray-400">{{ loan.book.cota }}</div>
                  </td>
                  {% if is_staff %}
                  <td class="px-4 py-3">
                    <div class="text-gray-700">{{ loan.user.get_full_name|default:loan.user.username }}</div>
                  </td>
                  {% endif %}
                  <td class="px-4 py-3 text-gray-500">
                    {{ loan.returned_at|date:"d/m/Y H:i" }}
                  </td>
                  <td class="px-4 py-3 text-center">
                    {% if loan.return_book_rating %}
                    <span class="inline-flex items-center text-amber-500">
                        {{ loan.return_book_rating }} <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                    </span>
                    {% else %}
                    <span class="text-gray-300">-</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          {% if history_loans.paginator.num_pages > 1 %}
          <div class="mt-4 flex justify-center text-sm">
            <nav class="inline-flex items-center -space-x-px">
              {% if history_loans.has_previous %}
                <a href="?page={{ history_loans.previous_page_number }}{% if q_history %}&q_history={{ q_history }}{% endif %}" class="px-3 py-1 border rounded-l hover:bg-gray-50">Anterior</a>
              {% endif %}
              <span class="px-3 py-1 border text-gray-500">{{ history_loans.number }} / {{ history_loans.paginator.num_pages }}</span>
              {% if history_loans.has_next %}
                <a href="?page={{ history_loans.next_page_number }}{% if q_history %}&q_history={{ q_history }}{% endif %}" class="px-3 py-1 border rounded-r hover:bg-gray-50">Siguiente</a>
              {% endif %}
            </nav>
          </div>
          {% endif %}
        {% else %}
          <p class="text-gray-400 italic text-center py-8">No hay registros en el historial.</p>
        {% endif %}
      </section>
    </div>
  </div>
</main>
{% endblock %}
