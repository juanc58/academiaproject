{% extends "base.html" %}
{% block content %}
<main class="px-8 py-8">
  <div class="container mx-auto max-w-7xl">
    <div class="bg-white shadow rounded-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl font-semibold">Reporte de {{ book.titulo }}</h2>
          
          <div class="text-sm text-gray-700">Promedio libro: {{ avg_book|default:'-'|floatformat:1 }} · Promedio receptor: {{ avg_receiver|default:'-'|floatformat:1 }}</div>
        </div>
        <form method="get" class="flex gap-2 items-center">
          <input type="date" name="start_date" value="{{ start_date }}" class="border rounded p-2" />
          <input type="date" name="end_date" value="{{ end_date }}" class="border rounded p-2" />
          <input type="number" name="min_score" value="{{ min_score }}" placeholder="Puntaje mínimo" min="1" max="5" class="border rounded p-2 w-32" />
          <button type="submit" class="px-3 py-2 bg-[#ee9211] text-white rounded">Aplicar</button>
          <a href="{% url 'reports_index' %}" class="px-3 py-2 bg-red-500 text-white rounded">Volver</a>
        </form>
      </div>
      {% if loans and loans.object_list %}
        <ul class="space-y-3">
          {% for loan in loans.object_list %}
            <li class="border p-3 rounded">
              <div class="font-semibold">Prestamo #{{ loan.id }}{% if loan.user %} — {{ loan.user.get_full_name|default:loan.user.username }}{% endif %}</div>
              <div class="text-sm text-gray-600">Aprobado: {% if loan.approved_at %}<span data-approved-at="{{ loan.approved_at|date:'c' }}">Cargando...</span>{% else %}Pendiente{% endif %} </div>
              <div class="text-sm text-gray-600">Devuelto: {% if loan.returned_at %}<span data-returned-at="{{ loan.returned_at|date:'c' }}">Cargando...</span>{% else %}No devuelto{% endif %}</div>
              {% if loan.receiver_first_name or loan.receiver_last_name or loan.receiver_cedula %}
                <div class="text-sm text-gray-600">Recibido por: {{ loan.receiver_first_name }} {{ loan.receiver_last_name }} {% if loan.receiver_cedula %} (Cédula: {{ loan.receiver_cedula }}){% endif %}</div>
              {% endif %}
              {% if loan.return_report %}
                <div class="mt-2">Reporte: {{ loan.return_report }}</div>
              {% endif %}
              <div class="mt-1 text-sm text-gray-700">Calificación libro: {{ loan.return_book_rating|default:'-' }} · Calificación receptor: {{ loan.return_receiver_rating|default:'-' }}</div>
            </li>
          {% endfor %}
        </ul>

        <div class="mt-4 flex justify-center">
          <nav class="inline-flex items-center">
            {% if loans.has_previous %}
              <a href="?page={{ loans.previous_page_number }}&start_date={{ start_date }}&end_date={{ end_date }}&min_score={{ min_score }}" class="px-3 py-1 border rounded-l">Anterior</a>
            {% else %}
              <span class="px-3 py-1 border rounded-l text-gray-400">Anterior</span>
            {% endif %}
            <span class="px-4 py-1 border-t border-b">Página {{ loans.number }} de {{ loans.paginator.num_pages }}</span>
            {% if loans.has_next %}
              <a href="?page={{ loans.next_page_number }}&start_date={{ start_date }}&end_date={{ end_date }}&min_score={{ min_score }}" class="px-3 py-1 border rounded-r">Siguiente</a>
            {% else %}
              <span class="px-3 py-1 border rounded-r text-gray-400">Siguiente</span>
            {% endif %}
          </nav>
        </div>
      {% else %}
        <div>No hay reportes para este libro.</div>
      {% endif %}
    </div>
  </div>
</main>
<script>
(function(){
  function formatISO(el){
    try{
      var iso = el.getAttribute('data-approved-at');
      if(iso){ var dt = new Date(iso); if(isNaN(dt.getTime())) dt = new Date(iso.replace(/(\+|-)([0-9]{2})([0-9]{2})$/, '$1$2:$3')); el.textContent = dt.toLocaleString(); }
    }catch(e){}
    try{
      var iso2 = el.getAttribute('data-returned-at');
      if(iso2){ var dt2 = new Date(iso2); if(isNaN(dt2.getTime())) dt2 = new Date(iso2.replace(/(\+|-)([0-9]{2})([0-9]{2})$/, '$1$2:$3')); el.textContent = dt2.toLocaleString(); }
    }catch(e){}
  }
  document.querySelectorAll('[data-approved-at]').forEach(function(x){ formatISO(x); });
  document.querySelectorAll('[data-returned-at]').forEach(function(x){ formatISO(x); });
})();
</script>
{% endblock %}
