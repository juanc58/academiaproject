{% comment %} Partial para un item de la lista de préstamos (li) {% endcomment %}
<li id="loan-{{ loan.id }}" class="glass-card rounded-2xl p-5 md:p-6 shadow-lg border border-white/40 backdrop-blur-xl flex flex-col md:flex-row md:items-center justify-between gap-4 transition-all hover:shadow-xl hover:bg-white/40 group">
  <div class="flex-1">
    <div class="flex items-center gap-3 mb-2">
      <div class="size-2 rounded-full {% if loan.status == loan.STATUS_ACTIVE %}bg-green-500 animate-pulse{% else %}bg-gray-400{% endif %}"></div>
      <h4 class="font-extrabold text-indigo-950 text-lg leading-tight">{{ loan.book.titulo }}</h4>
    </div>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 mt-3">
      {% if loan.user %}
        <div class="flex items-center text-sm text-indigo-900/70 font-medium">
          <svg class="size-4 mr-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-width="2"/></svg>
          {{ loan.user.get_full_name|default:loan.user.username }}
        </div>
      {% endif %}
      
      <div class="flex items-center text-sm text-indigo-900/70 font-medium">
        <svg class="size-4 mr-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" stroke-width="2"/></svg>
        {{ loan.book.cota }}
      </div>

      <div class="flex items-center text-sm text-indigo-900/70 font-medium">
        <svg class="size-4 mr-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" stroke-width="2"/></svg>
        Cantidad: {{ loan.cantidad }}
      </div>

      <div class="flex items-center text-sm font-bold {% if loan.status == loan.STATUS_ACTIVE %}text-green-600{% else %}text-gray-500{% endif %}">
        <svg class="size-4 mr-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg>
        {{ loan.get_status_display }}
      </div>
    </div>

    {% if loan.approved_at or loan.returned_at %}
    <div class="mt-4 pt-4 border-t border-indigo-100/50 flex flex-wrap gap-4">
      {% if loan.approved_at %}
        <div class="text-[11px] uppercase tracking-wider font-bold text-indigo-600/60" data-approved-at="{{ loan.approved_at|date:'c' }}">
          Aprobado: <span class="approved-placeholder text-indigo-950">...</span>
        </div>
      {% endif %}
      {% if loan.returned_at %}
        <div class="text-[11px] uppercase tracking-wider font-bold text-amber-600/60" data-returned-at="{{ loan.returned_at|date:'c' }}">
          Devuelto: <span class="returned-placeholder text-indigo-950">...</span>
        </div>
      {% endif %}
    </div>
    {% endif %}

    {% if loan.return_report %}
      <div class="mt-3 bg-white/30 rounded-xl p-3 border border-white/20">
        <p class="text-xs font-bold text-indigo-900/40 uppercase mb-1">Reporte de devolución</p>
        <p class="text-sm text-indigo-950 leading-relaxed italic">"{{ loan.return_report }}"</p>
      </div>
    {% endif %}
  </div>

  <div class="md:pl-6 border-l-0 md:border-l border-indigo-100/50 flex items-center">
    {% if loan.status == loan.STATUS_ACTIVE %}
      <button class="w-full md:w-auto px-6 py-2.5 bg-[#F9CE69] text-indigo-950 font-extrabold rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105 active:scale-95 ajax-return-btn text-sm" data-loan-id="{{ loan.id }}" data-book-id="{{ loan.book.id }}">
        Devolver
      </button>
    {% else %}
      <div class="flex flex-col items-center">
        {% if loan.return_book_rating %}
        <div class="flex gap-0.5 mb-1">
          {% for i in "12345"|make_list %}<span class="text-[10px] {% if forloop.counter <= loan.return_book_rating %}text-amber-400{% else %}text-gray-300{% endif %}">★</span>{% endfor %}
        </div>
        {% endif %}
        <span class="text-[10px] font-bold text-indigo-900/30 uppercase tracking-widest">Finalizado</span>
      </div>
    {% endif %}
  </div>
</li>
