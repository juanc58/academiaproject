<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Detalle libro</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
</head>
<body class="bg-gray-200 p-2">
  <div class="max-w-4xl mx-auto bg-white shadow rounded-lg p-6 border-[#F9CE69] border-solid border-4">
    <div class="flex items-start justify-between mb-4">
      <div class="flex items-center gap-3">
        {% if user.is_authenticated %}
          
        {% else %}
          <p class="text-xl text-black">Para editar este libro debe <a href="{% url 'signin' %}?next={% url 'task_edit' book.id %}" class="text-[#0366d6] underline">iniciar sesión</a>.</p>
        {% endif %}

        
      </div>

    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="md:col-span-2">
        <h1 class="text-3xl font-semibold text-gray-800">{{ book.titulo }}</h1>
        {% if book.subtitulo %}
          <p class="text-gray-600 text-2xl mt-1 italic">{{ book.subtitulo }}</p>
        {% endif %}

        <dl class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm text-gray-700">
          <div>
            <dt class="text-xl text-black">Cota</dt>
            <dd class="text-lg mt-1">{{ book.cota }}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Autor</dt>
            <dd class="text-lg mt-1">{{ book.autor }}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Coautor</dt>
            <dd class="text-lg mt-1">{{ book.co_autor }}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Año publicación</dt>
            <dd class="text-lg mt-1">{% if book.fecha_publicacion %}{{ book.fecha_publicacion|date:"Y" }}{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Editorial</dt>
            <dd class="text-lg mt-1">{{ book.editorial }}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Edición</dt>
            <dd class="text-lg mt-1">{{ book.edicion }}ª</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Ubicación publicación</dt>
            <dd class="text-lg mt-1">{{ book.ubicacion_publicacion }}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Volumen</dt>
            <dd class="text-lg mt-1">{{ book.volumen }}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Páginas</dt>
            <dd class="text-lg mt-1">{{ book.paginas }}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Cantidad</dt>
            <dd class="text-lg mt-1">{{ book.cantidad }}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">N.º registro</dt>
            <dd class="text-lg mt-1">{% if book.numero_registro %}{{ book.numero_registro }}{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Fecha de registro</dt>
            <dd class="text-lg mt-1">{% if book.fecha_registro %}{{ book.fecha_registro|date:"Y-m-d" }}{% else %}—{% endif %}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Prestados</dt>
            <dd class="text-lg mt-1" data-book-count="{{ book.id }}">{{ prestados|default:0 }} / {{ total|default:0 }}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Serie</dt>
            <dd class="text-lg mt-1">{{ book.serie }}</dd>
          </div>
          <div>
            <dt class="text-xl text-black">Número serie</dt>
            <dd class="text-lg mt-1">{{ book.numero_serie }}</dd>
          </div>
          {# Campos 'especialidad' y 'datos_control' eliminados - la clasificación se gestiona por Clasificacion #}
          <div>
            <dt class="text-xl text-black">Dimensiones</dt>
            <dd class="text-lg mt-1">{{ book.dimensiones }}</dd>
          </div>
          <div class="sm:col-span-2">
            <dt class="text-xl text-black">Contenido del libro</dt>
            <dd class="text-lg mt-1">{{ book.contenido }}</dd>
          </div>
          <div class="sm:col-span-2">
            <dt class="text-xl text-black">Clasificación</dt>
            <dd class="text-lg mt-1">{% if book.classification %}{{ book.classification }}{% else %}—{% endif %}</dd>
          </div>
          <div class="sm:col-span-2">
            <dt class="text-xl text-black">Descripción</dt>
            <dd class="text-lg mt-1">{% if book.descripcion %}{{ book.descripcion }}{% else %}—{% endif %}</dd>
          </div>
          <div class="sm:col-span-2">
            <dt class="text-xl text-black">Descripción (EN)</dt>
            <dd class="text-lg mt-1">{% if book.descripcion_en %}{{ book.descripcion_en }}{% else %}—{% endif %}</dd>
          </div>
        </dl>
      </div>

      <div class="flex flex-col items-center">
        {% if book.portada %}
          <img src="{{ book.portada.url }}" alt="Portada {{ book.titulo }}" class="w-48 h-auto rounded border" />
        {% else %}
          <div class="w-48 h-64 bg-gray-100 rounded border flex items-center justify-center text-gray-400">Sin portada</div>
        {% endif %}

        <div class="mt-4 text-center md:pr-6 w-full">
          {% if user.is_staff or user.is_superuser %}
            {% if book.is_active or user.is_superuser %}
              <a href="{% url 'task_edit' book.id %}" onclick="window.location=this.href; return false;" class="text-white w-full  max-w-sm rounded-md text-center bg-[#4741a6] mb-2 py-2 px-6 inline-flex items-center focus:outline-none md:float-left space hover:bg-[#2f27a0]">  
                <svg class="w-4 mr-2" viewBox="0 -3 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns" fill="#ffffff" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>checkmark</title> <desc>Created with Sketch Beta.</desc> <defs> </defs> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage"> <g id="Icon-Set-Filled" sketch:type="MSLayerGroup" transform="translate(-518.000000, -1039.000000)" fill="#ffffff"> <path d="M548.783,1040.2 C547.188,1038.57 544.603,1038.57 543.008,1040.2 L528.569,1054.92 L524.96,1051.24 C523.365,1049.62 520.779,1049.62 519.185,1051.24 C517.59,1052.87 517.59,1055.51 519.185,1057.13 L525.682,1063.76 C527.277,1065.39 529.862,1065.39 531.457,1063.76 L548.783,1046.09 C550.378,1044.46 550.378,1041.82 548.783,1040.2" id="checkmark" sketch:type="MSShapeGroup"> </path> </g> </g> </g></svg>Editar</a>
            {% else %}
              <button disabled class="text-sm w-full max-w-sm bg-gray-300 text-gray-700 py-2 px-6 rounded mb-2">Editar (inactivo)</button>
            {% endif %}
          {% endif %}

          {% if book.is_active %}
            <a href="{% url 'task_pdf_card' book.id %}" target="_blank" class="text-white w-full  max-w-sm rounded-md text-center bg-[#68d6f8] mb-2 py-2 px-6 inline-flex items-center focus:outline-none md:float-left space hover:bg-[#00c3ff] ">
            <svg class="w-6 mr-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#ffffff" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title></title> <g id="Complete"> <g id="download"> <g> <path d="M3,12.3v7a2,2,0,0,0,2,2H19a2,2,0,0,0,2-2v-7" fill="none" stroke="#ffffff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path> <g> <polyline data-name="Right" fill="none" id="Right-2" points="7.9 12.3 12 16.3 16.1 12.3" stroke="#ffffff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></polyline> <line fill="none" stroke="#ffffff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="12" x2="12" y1="2.7" y2="14.2"></line> </g> </g> </g> </g> </g></svg>Descargar ficha</a>
          {% else %}
            <button disabled class="text-sm w-full max-w-sm bg-gray-300 text-gray-700 py-2 px-6 rounded mb-2">Descargar ficha (inactivo)</button>
          {% endif %}
          <button onclick="window.close()" class="text-white w-full  max-w-sm rounded-md text-center bg-red-400 mb-2 py-2 px-6  items-center focus:outline-none md:float-left space hover:bg-red-600 ">Cerrar</button>
        
          <!-- Botón para abrir modal de carrito / solicitar -->
          <div class="mt-3 w-full text-center">
            {% if book.is_active %}
              {% if total > prestados %}
                <button id="open-cart-btn" class="w-full max-w-sm bg-yellow-400 text-black py-2 px-4 rounded">Lista préstamo</button>
              {% else %}
                <button disabled class="w-full max-w-sm bg-gray-300 text-gray-600 py-2 px-4 rounded">Agotado</button>
              {% endif %}
            {% else %}
              <button disabled class="w-full max-w-sm bg-gray-300 text-gray-600 py-2 px-4 rounded">Libro inactivo</button>
            {% endif %}
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Modal de carrito -->
  <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <!-- inner modal: limit height and allow internal scroll when content is large -->
    <div class="bg-white rounded-lg w-11/12 max-w-3xl p-6" style="max-height: calc(100vh - 80px); overflow-y: auto;">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Carrito de solicitudes</h3>
        <button id="close-cart" class="text-gray-600">Cerrar</button>
      </div>
      <div id="cart-contents" style="max-height:50vh; overflow-y:auto;">
        <p class="text-sm text-gray-600">Cargando...</p>
      </div>
      <div id="cart-error" class="text-sm text-red-600 mb-2 hidden"></div>
      <div class="mt-4 flex gap-2 justify-end">
        <button id="checkout-btn" class="px-4 py-2 bg-indigo-600 text-white rounded">Confirmar solicitud</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const modal = document.getElementById('cart-modal');
      const openBtn = document.getElementById('open-cart-btn');
      const closeBtn = document.getElementById('close-cart');
      const contents = document.getElementById('cart-contents');
      const checkoutBtn = document.getElementById('checkout-btn');

      function getCSRF(){
        try{ var t = document.querySelector('input[name=csrfmiddlewaretoken]'); if(t) return t.value; }catch(e){}
        function getCookie(name){var v = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v ? v.pop() : '';}
        return getCookie('csrftoken');
      }

      function fetchCart(){
        contents.innerHTML = '<p class="text-sm text-gray-600">Cargando...</p>';
        fetch('{% url "cart_json" %}', {credentials: 'same-origin'})
          .then(r=>r.json()).then(data=>{
            if(!data || !data.items) { contents.innerHTML = '<div class="text-sm text-gray-600">No hay items.</div>'; return; }
            renderCart(data.items, data.loan_cart_user);
          }).catch(()=>{ contents.innerHTML = '<div class="text-sm text-gray-600">Error cargando carrito.</div>'; });
      }

      function renderCart(items, loan_user){
        if(!items.length){
          contents.innerHTML = '<div class="text-sm text-gray-600">No hay libros en el carrito.</div>';
          return;
        }
        let html = '<div class="space-y-3">';
        items.forEach(b=>{
          html += `<div class="flex items-center justify-between border p-3 rounded">
            <div class="flex items-center gap-4">
              ${b.portada ? `<img src="${b.portada}" class="w-16 h-20 object-cover rounded" alt="${b.titulo}">` : '<div class="w-16 h-20 bg-gray-100 rounded flex items-center justify-center text-sm text-gray-500">Sin portada</div>'}
              <div>
                <div class="font-semibold">${escapeHtml(b.titulo)}</div>
                <div class="text-sm text-gray-600">Autor: ${escapeHtml(b.autor || '-') }</div>
                <div class="text-sm text-gray-600">Cota: ${escapeHtml(b.cota || '-') }</div>
                <div class="text-sm text-gray-600">Prestados: ${b.prestados} / ${b.total}</div>
              </div>
            </div>
            <div class="text-right">
              <form onsubmit="return false;" data-id="${b.id}">
                <button class="remove-btn px-3 py-1 bg-red-500 text-white rounded text-sm">Quitar</button>
              </form>
            </div>
          </div>`;
        });
        html += '</div>';
        html += `<div class="mt-3 text-sm text-gray-700">Solicitado por: <span class="font-medium">${escapeHtml(loan_user||'')}</span></div>`;
        contents.innerHTML = html;
        // attach remove handlers
        contents.querySelectorAll('form[data-id]').forEach(f=>{
          f.addEventListener('submit', function(e){ e.preventDefault(); const id = f.getAttribute('data-id'); removeFromCart(id); });
          // also attach click on button
          const btn = f.querySelector('.remove-btn'); if(btn) btn.addEventListener('click', function(e){ e.preventDefault(); const id = f.getAttribute('data-id'); removeFromCart(id); });
        });
      }

      function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`=\/]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","/":"\/","=`":"&#61;"}[c] || c; }); }

      function addToCart(id){
        fetch('{% url "cart_add" 0 %}'.replace('/0/','/' + id + '/'), {
          method: 'POST',
          headers: {'X-Requested-With':'XMLHttpRequest','X-CSRFToken': getCSRF()},
          credentials: 'same-origin'
        }).then(r=>r.json()).then(data=>{
          if(data && data.ok){ fetchCart(); alert('Libro añadido al carrito'); }
          else alert(data && data.message ? data.message : 'No se pudo añadir');
        }).catch(()=>{ alert('Error de red al añadir'); });
      }

      function removeFromCart(id){
        fetch('{% url "cart_remove" 0 %}'.replace('/0/','/' + id + '/'), {
          method: 'POST', headers: {'X-CSRFToken': getCSRF(), 'X-Requested-With':'XMLHttpRequest'}, credentials: 'same-origin'
        }).then(r=>r.json()).then(data=>{ if(data && data.ok){ fetchCart(); } }).catch(()=>{});
      }

      function doCheckout(){
        var errEl = document.getElementById('cart-error');
        function showError(msg){ if(errEl){ errEl.textContent = msg; errEl.classList.remove('hidden'); } else alert(msg); }
        function clearError(){ if(errEl){ errEl.textContent = ''; errEl.classList.add('hidden'); } }
        clearError();

        fetch('{% url "cart_checkout" %}', {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRF(),
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        }).then(r=>{
          if(!r.ok) return r.json().then(j=>{ throw j; });
          return r.json();
        }).then(data=>{
          if(data && data.ok){ fetchCart(); clearError(); alert('Solicitud enviada correctamente.'); modal.classList.add('hidden'); }
          else { showError('No se pudo procesar la solicitud'); }
        }).catch(err=>{
          showError(err && err.error ? err.error : 'Error al confirmar solicitud');
        });
      }

      if(openBtn){ openBtn.addEventListener('click', function(){ modal.classList.remove('hidden'); fetchCart(); }); }
      if(closeBtn){ closeBtn.addEventListener('click', function(){ modal.classList.add('hidden'); }); }
      if(checkoutBtn){ checkoutBtn.addEventListener('click', function(){ if(confirm('Confirmar solicitud de los libros listados?')) doCheckout(); }); }

      // Exponer refreshCartModal para que otras páginas puedan solicitar actualización
      window.refreshCartModal = function(){
        // refresca modal si está abierto
        try{ if(modal && !modal.classList.contains('hidden')) fetchCart(); }catch(e){}
        // actualizar contador del libro actual
        fetch('{% url "cart_json" %}', {credentials:'same-origin'}).then(r=>r.json()).then(data=>{
          if(!data || !data.items) return;
          data.items.forEach(function(it){
            var el = document.querySelector('[data-book-count="' + it.id + '"]');
            if(el) el.textContent = 'Prestados: ' + it.prestados + ' / ' + it.total;
          });
          // actualizar badge si existe
          try{ var badge=document.getElementById('cart-badge'); if(badge){ var first=data.items[0]; if(first) badge.textContent='Prestado: '+first.prestados+'/'+first.total; } }catch(e){}
        }).catch(()=>{});
      };

      // Añadir funcionalidad: si usuario hace click en "Solicitar préstamo" desde detalle, también intentar añadir este libro si no está en el carrito
      // Si botón existe (lo mismo que openBtn), al abrir el modal no añadimos automáticamente; si quieres auto-add, lo implementamos.

    })();
  </script>
</body>
</html>