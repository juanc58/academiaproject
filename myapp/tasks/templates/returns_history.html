{% extends "base.html" %}
{% load tz %}
{% block content %}
<main class="px-8 py-8">
  <div class="container mx-auto max-w-6xl">
    <div class="bg-white shadow rounded-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="inline-flex items-center space-x-4 -mt-3">
        <h1 class="text-2xl font-bold">Historial de Devoluciones</h1>
        <svg class="size-10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M23 12C23 18.0751 18.0751 23 12 23C5.92487 23 1 18.0751 1 12C1 5.92487 5.92487 1 12 1C18.0751 1 23 5.92487 23 12ZM3.00683 12C3.00683 16.9668 7.03321 20.9932 12 20.9932C16.9668 20.9932 20.9932 16.9668 20.9932 12C20.9932 7.03321 16.9668 3.00683 12 3.00683C7.03321 3.00683 3.00683 7.03321 3.00683 12Z" fill="#77df83"></path> <path d="M12 5C11.4477 5 11 5.44771 11 6V12.4667C11 12.4667 11 12.7274 11.1267 12.9235C11.2115 13.0898 11.3437 13.2343 11.5174 13.3346L16.1372 16.0019C16.6155 16.278 17.2271 16.1141 17.5032 15.6358C17.7793 15.1575 17.6155 14.5459 17.1372 14.2698L13 11.8812V6C13 5.44772 12.5523 5 12 5Z" fill="#77df83"></path> </g></svg>
      </div>
        <form method="get" class="flex gap-2 items-center">
          <input type="text" name="q" value="{{ q }}" placeholder="Buscar título..." class="border rounded p-2" />
          <input type="date" name="start_date" value="{{ start_date }}" class="border rounded p-2" />
          <input type="date" name="end_date" value="{{ end_date }}" class="border rounded p-2" />
          <button type="submit" class="px-3 py-2 bg-blue-600 text-white rounded">Filtrar</button>
          <a href="{% url 'my_loans' %}" class="px-3 py-2 bg-red-600 text-white rounded">Volver</a>
        </form>
      </div>
      {% if returned and returned.object_list %}
        <ul class="space-y-3" id="returned-list">
          {% for loan in returned.object_list %}
            {% include 'tasks/_loan_item.html' with loan=loan %}
          {% endfor %}
        </ul>

        <div class="mt-4 flex justify-center">
          <nav class="inline-flex items-center">
            {% if returned.has_previous %}
              <a href="?page={{ returned.previous_page_number }}&q={{ q }}&start_date={{ start_date }}&end_date={{ end_date }}" class="px-3 py-1 border rounded-l">Anterior</a>
            {% else %}
              <span class="px-3 py-1 border rounded-l text-gray-400">Anterior</span>
            {% endif %}
            <span class="px-4 py-1 border-t border-b">Página {{ returned.number }} de {{ returned.paginator.num_pages }}</span>
            {% if returned.has_next %}
              <a href="?page={{ returned.next_page_number }}&q={{ q }}&start_date={{ start_date }}&end_date={{ end_date }}" class="px-3 py-1 border rounded-r">Siguiente</a>
            {% else %}
              <span class="px-3 py-1 border rounded-r text-gray-400">Siguiente</span>
            {% endif %}
          </nav>
        </div>
      {% else %}
        <div>No hay devoluciones registradas.</div>
      {% endif %}
    </div>
  </div>
</main>
<script>
// Formatear fechas igual que en my_loans
(function(){
  function formatISO(el, attrName, placeholderClass){
    try{
      var iso = el.getAttribute(attrName);
      if(!iso) return;
      var dt = new Date(iso);
      if(isNaN(dt.getTime())){
        try{ dt = new Date(iso.replace(/(\+|-)([0-9]{2})([0-9]{2})$/, '$1$2:$3')); }catch(e){}
      }
      var txt = isNaN(dt.getTime()) ? iso : dt.toLocaleString();
      var span = el.querySelector('.' + placeholderClass);
      if(span) span.textContent = txt; else el.textContent = txt;
    }catch(e){ }
  }
  document.querySelectorAll('[data-approved-at]').forEach(function(el){ formatISO(el, 'data-approved-at', 'approved-placeholder'); });
  document.querySelectorAll('[data-returned-at]').forEach(function(el){ formatISO(el, 'data-returned-at', 'returned-placeholder'); });
})();
</script>
{% endblock %}
